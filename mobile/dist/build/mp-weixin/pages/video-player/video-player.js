"use strict";const e=require("../../common/vendor.js"),t={data:()=>({videoId:"secureVideo",lessonId:0,userId:"",videoUrl:"",accessToken:"",isLoading:!0,isPlaying:!1,isBlocked:!1,currentTime:0,duration:0,showControls:!0,controlsTimer:null,watermarkText:"",watermarkPosition:"top-right",watermarkTimer:null,heartbeatTimer:null,lessonInfo:{}}),computed:{progressPercent(){return this.duration>0?this.currentTime/this.duration*100:0}},onLoad(e){this.lessonId=parseInt(e.lessonId),this.userId=e.userId||"user_123",this.initializePlayer()},onUnload(){this.cleanup()},onHide(){this.pauseVideo(),this.blockVideo("检测到页面切换")},onShow(){this.isBlocked&&this.resumeVideo()},methods:{async initializePlayer(){var t;try{const o=await e.index.request({url:`/api/video/lessons/${this.lessonId}/play-url`,method:"GET",data:{user_id:this.userId}});if(o.data){const e=o.data;this.videoUrl=e.video_url,this.accessToken=e.access_token,this.watermarkText=(null==(t=e.watermark_config)?void 0:t.content)||"",this.lessonInfo=e.lesson_info||{},this.setupWatermark(e.watermark_config),this.startHeartbeat(e.security_config)}}catch(o){console.error("初始化播放器失败:",o),e.index.showToast({title:"视频加载失败",icon:"error"})}finally{this.isLoading=!1}},setupWatermark(e){e&&e.interval&&(this.watermarkTimer=setInterval(()=>{const e=["top-left","top-right","bottom-left","bottom-right"];this.watermarkPosition=e[Math.floor(Math.random()*e.length)]},1e3*e.interval))},startHeartbeat(t){(null==t?void 0:t.heartbeat_interval)&&(this.heartbeatTimer=setInterval(async()=>{var t;try{(null==(t=(await e.index.request({url:`/api/video/lessons/${this.lessonId}/heartbeat`,method:"POST",data:{user_id:this.userId,current_time:Math.floor(this.currentTime),token:this.accessToken}})).data)?void 0:t.continue_play)||this.blockVideo("会话已过期")}catch(o){console.error("心跳检测失败:",o)}},1e3*t.heartbeat_interval))},togglePlay(){this.isBlocked||(this.isPlaying?this.pauseVideo():this.playVideo())},playVideo(){if(this.isBlocked)return;e.index.createVideoContext(this.videoId,this).play(),this.isPlaying=!0},pauseVideo(){e.index.createVideoContext(this.videoId,this).pause(),this.isPlaying=!1},seekTo(t){if(this.isBlocked||!this.duration)return;t.detail||t.target.getBoundingClientRect();const o=.5*this.duration;e.index.createVideoContext(this.videoId,this).seek(o),this.currentTime=o},toggleControls(){this.showControls=!this.showControls,this.showControls&&(clearTimeout(this.controlsTimer),this.controlsTimer=setTimeout(()=>{this.showControls=!1},3e3))},blockVideo(t){this.isBlocked=!0,this.pauseVideo(),e.index.showToast({title:`视频已暂停: ${t}`,icon:"error",duration:3e3}),this.recordViolation(t)},resumeVideo(){this.isBlocked=!1},async recordViolation(t){try{await e.index.request({url:`/api/video/lessons/${this.lessonId}/violation`,method:"POST",data:{user_id:this.userId,reason:t,timestamp:Date.now()}})}catch(o){console.error("记录违规失败:",o)}},onVideoLoaded(e){this.duration=e.detail.duration,this.isLoading=!1},onTimeUpdate(e){this.currentTime=e.detail.currentTime},onVideoEnded(){this.isPlaying=!1,this.markLessonCompleted()},onVideoError(t){console.error("视频播放错误:",t),e.index.showToast({title:"播放失败",icon:"error"})},async markLessonCompleted(){try{await e.index.request({url:`/api/video/lessons/${this.lessonId}/complete`,method:"POST",data:{user_id:this.userId,token:this.accessToken}}),e.index.showToast({title:"课程已完成",icon:"success"})}catch(t){console.error("标记完成失败:",t)}},formatTime(e){const t=Math.floor(e/60),o=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`},formatDuration:e=>`${Math.floor(e/60)}分${e%60}秒`,goBack(){e.index.navigateBack()},cleanup(){this.watermarkTimer&&clearInterval(this.watermarkTimer),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.controlsTimer&&clearTimeout(this.controlsTimer)}}};const o=e._export_sfc(t,[["render",function(t,o,i,s,r,n){return e.e({a:e.o((...e)=>n.goBack&&n.goBack(...e)),b:e.t(r.lessonInfo.title),c:!r.isBlocked},r.isBlocked?{}:e.e({d:r.videoId,e:r.videoUrl,f:e.o((...e)=>n.onVideoLoaded&&n.onVideoLoaded(...e)),g:e.o((...e)=>n.onTimeUpdate&&n.onTimeUpdate(...e)),h:e.o((...e)=>n.onVideoEnded&&n.onVideoEnded(...e)),i:e.o((...e)=>n.onVideoError&&n.onVideoError(...e)),j:r.watermarkText},r.watermarkText?{k:e.t(r.watermarkText),l:e.n(r.watermarkPosition)}:{},{m:e.t(r.isPlaying?"⏸️":"▶️"),n:e.o((...e)=>n.togglePlay&&n.togglePlay(...e)),o:n.progressPercent+"%",p:e.o((...e)=>n.seekTo&&n.seekTo(...e)),q:e.t(n.formatTime(r.currentTime)),r:e.t(n.formatTime(r.duration)),s:r.showControls,t:e.o((...e)=>n.toggleControls&&n.toggleControls(...e))}),{v:r.isBlocked},r.isBlocked?{w:e.o((...e)=>n.resumeVideo&&n.resumeVideo(...e))}:{},{x:r.isLoading},(r.isLoading,{}),{y:r.lessonInfo.title},r.lessonInfo.title?e.e({z:e.t(r.lessonInfo.title),A:r.lessonInfo.description},r.lessonInfo.description?{B:e.t(r.lessonInfo.description)}:{},{C:e.t(r.lessonInfo.order),D:r.lessonInfo.duration},r.lessonInfo.duration?{E:e.t(n.formatDuration(r.lessonInfo.duration))}:{}):{})}]]);wx.createPage(o);
